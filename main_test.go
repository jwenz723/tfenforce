package main

import (
	"encoding/json"
	tfjson "github.com/hashicorp/terraform-json"
	"github.com/stretchr/testify/assert"
	"testing"
)

func TestCheckIamPolicyStar(t *testing.T) {
	var tests = map[string]struct {
		policy string
		expect []string
	}{
		"failed iam policy": {
			policy: `{"format_version":"0.1","terraform_version":"0.12.12","planned_values":{"root_module":{"resources":[{"address":"aws_iam_policy.service-policy-default","mode":"managed","type":"aws_iam_policy","name":"service-policy-default","provider_name":"aws","schema_version":0,"values":{"description":"This policy contains default permissions that will be granted to pods in eks clusters if a kube2iam role annotation is not specified on a pod.","name":"test-default","name_prefix":null,"path":"/","policy":"{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"*\",\n                \"eks:ListClusters\"\n            ],\n            \"Resource\": \"arn:aws:eks:*:197353405550:cluster/*\"\n        }\n    ]\n}\n"}},{"address":"aws_iam_role.service-role-default","mode":"managed","type":"aws_iam_role","name":"service-role-default","provider_name":"aws","schema_version":0,"values":{"assume_role_policy":"{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"ec2.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\n","description":"The default role that will used by kube2iam in eks clusters.","force_detach_policies":false,"max_session_duration":3600,"name":"test-default","name_prefix":null,"path":"/","permissions_boundary":null,"tags":null}},{"address":"aws_iam_role_policy_attachment.service-policy-attachment-default","mode":"managed","type":"aws_iam_role_policy_attachment","name":"service-policy-attachment-default","provider_name":"aws","schema_version":0,"values":{"role":"test-default"}}]}},"resource_changes":[{"address":"aws_iam_policy.service-policy-default","mode":"managed","type":"aws_iam_policy","name":"service-policy-default","provider_name":"aws","change":{"actions":["create"],"before":null,"after":{"description":"This policy contains default permissions that will be granted to pods in eks clusters if a kube2iam role annotation is not specified on a pod.","name":"test-default","name_prefix":null,"path":"/","policy":"{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"*\",\n                \"eks:ListClusters\"\n            ],\n            \"Resource\": \"arn:aws:eks:*:197353405550:cluster/*\"\n        }\n    ]\n}\n"},"after_unknown":{"arn":true,"id":true}}},{"address":"aws_iam_role.service-role-default","mode":"managed","type":"aws_iam_role","name":"service-role-default","provider_name":"aws","change":{"actions":["create"],"before":null,"after":{"assume_role_policy":"{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"ec2.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\n","description":"The default role that will used by kube2iam in eks clusters.","force_detach_policies":false,"max_session_duration":3600,"name":"test-default","name_prefix":null,"path":"/","permissions_boundary":null,"tags":null},"after_unknown":{"arn":true,"create_date":true,"id":true,"unique_id":true}}},{"address":"aws_iam_role_policy_attachment.service-policy-attachment-default","mode":"managed","type":"aws_iam_role_policy_attachment","name":"service-policy-attachment-default","provider_name":"aws","change":{"actions":["create"],"before":null,"after":{"role":"test-default"},"after_unknown":{"id":true,"policy_arn":true}}}],"prior_state":{"format_version":"0.1","terraform_version":"0.12.12","values":{"root_module":{"resources":[{"address":"data.aws_caller_identity.current","mode":"data","type":"aws_caller_identity","name":"current","provider_name":"aws","schema_version":0,"values":{"account_id":"197353405550","arn":"arn:aws:iam::197353405550:user/jeff.wenzbauer","id":"2019-10-23 22:41:16.618812 +0000 UTC","user_id":"AIDAIJRVWOOD62AKW2AJ4"}}]}}},"configuration":{"provider_config":{"aws":{"name":"aws","version_constraint":"~\u003e 2.0","expressions":{"region":{"constant_value":"us-west-2"}}}},"root_module":{"resources":[{"address":"aws_iam_policy.service-policy-default","mode":"managed","type":"aws_iam_policy","name":"service-policy-default","provider_config_key":"aws","expressions":{"description":{"constant_value":"This policy contains default permissions that will be granted to pods in eks clusters if a kube2iam role annotation is not specified on a pod."},"name":{"constant_value":"test-default"},"policy":{"references":["data.aws_caller_identity.current"]}},"schema_version":0},{"address":"aws_iam_role.service-role-default","mode":"managed","type":"aws_iam_role","name":"service-role-default","provider_config_key":"aws","expressions":{"assume_role_policy":{"constant_value":"{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"ec2.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\n"},"description":{"constant_value":"The default role that will used by kube2iam in eks clusters."},"name":{"constant_value":"test-default"}},"schema_version":0},{"address":"aws_iam_role_policy_attachment.service-policy-attachment-default","mode":"managed","type":"aws_iam_role_policy_attachment","name":"service-policy-attachment-default","provider_config_key":"aws","expressions":{"policy_arn":{"references":["aws_iam_policy.service-policy-default"]},"role":{"references":["aws_iam_role.service-role-default"]}},"schema_version":0},{"address":"data.aws_caller_identity.current","mode":"data","type":"aws_caller_identity","name":"current","provider_config_key":"aws","schema_version":0}]}}}`,
			expect: []string{"aws_iam_policy.service-policy-default"},
		},
		"ok iam policy": {
			policy: `{"format_version":"0.1","terraform_version":"0.12.12","planned_values":{"root_module":{"resources":[{"address":"aws_iam_policy.service-policy-default","mode":"managed","type":"aws_iam_policy","name":"service-policy-default","provider_name":"aws","schema_version":0,"values":{"description":"This policy contains default permissions that will be granted to pods in eks clusters if a kube2iam role annotation is not specified on a pod.","name":"test-default","name_prefix":null,"path":"/","policy":"{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"eks:DescribeCluster\",\n                \"eks:ListClusters\"\n            ],\n            \"Resource\": \"arn:aws:eks:*:197353405550:cluster/*\"\n        }\n    ]\n}\n"}},{"address":"aws_iam_role.service-role-default","mode":"managed","type":"aws_iam_role","name":"service-role-default","provider_name":"aws","schema_version":0,"values":{"assume_role_policy":"{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"ec2.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\n","description":"The default role that will used by kube2iam in eks clusters.","force_detach_policies":false,"max_session_duration":3600,"name":"test-default","name_prefix":null,"path":"/","permissions_boundary":null,"tags":null}},{"address":"aws_iam_role_policy_attachment.service-policy-attachment-default","mode":"managed","type":"aws_iam_role_policy_attachment","name":"service-policy-attachment-default","provider_name":"aws","schema_version":0,"values":{"role":"test-default"}}]}},"resource_changes":[{"address":"aws_iam_policy.service-policy-default","mode":"managed","type":"aws_iam_policy","name":"service-policy-default","provider_name":"aws","change":{"actions":["create"],"before":null,"after":{"description":"This policy contains default permissions that will be granted to pods in eks clusters if a kube2iam role annotation is not specified on a pod.","name":"test-default","name_prefix":null,"path":"/","policy":"{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"eks:DescribeCluster\",\n                \"eks:ListClusters\"\n            ],\n            \"Resource\": \"arn:aws:eks:*:197353405550:cluster/*\"\n        }\n    ]\n}\n"},"after_unknown":{"arn":true,"id":true}}},{"address":"aws_iam_role.service-role-default","mode":"managed","type":"aws_iam_role","name":"service-role-default","provider_name":"aws","change":{"actions":["create"],"before":null,"after":{"assume_role_policy":"{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"ec2.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\n","description":"The default role that will used by kube2iam in eks clusters.","force_detach_policies":false,"max_session_duration":3600,"name":"test-default","name_prefix":null,"path":"/","permissions_boundary":null,"tags":null},"after_unknown":{"arn":true,"create_date":true,"id":true,"unique_id":true}}},{"address":"aws_iam_role_policy_attachment.service-policy-attachment-default","mode":"managed","type":"aws_iam_role_policy_attachment","name":"service-policy-attachment-default","provider_name":"aws","change":{"actions":["create"],"before":null,"after":{"role":"test-default"},"after_unknown":{"id":true,"policy_arn":true}}}],"prior_state":{"format_version":"0.1","terraform_version":"0.12.12","values":{"root_module":{"resources":[{"address":"data.aws_caller_identity.current","mode":"data","type":"aws_caller_identity","name":"current","provider_name":"aws","schema_version":0,"values":{"account_id":"197353405550","arn":"arn:aws:iam::197353405550:user/jeff.wenzbauer","id":"2019-10-23 22:47:25.509677 +0000 UTC","user_id":"AIDAIJRVWOOD62AKW2AJ4"}}]}}},"configuration":{"provider_config":{"aws":{"name":"aws","version_constraint":"~\u003e 2.0","expressions":{"region":{"constant_value":"us-west-2"}}}},"root_module":{"resources":[{"address":"aws_iam_policy.service-policy-default","mode":"managed","type":"aws_iam_policy","name":"service-policy-default","provider_config_key":"aws","expressions":{"description":{"constant_value":"This policy contains default permissions that will be granted to pods in eks clusters if a kube2iam role annotation is not specified on a pod."},"name":{"constant_value":"test-default"},"policy":{"references":["data.aws_caller_identity.current"]}},"schema_version":0},{"address":"aws_iam_role.service-role-default","mode":"managed","type":"aws_iam_role","name":"service-role-default","provider_config_key":"aws","expressions":{"assume_role_policy":{"constant_value":"{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"ec2.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\n"},"description":{"constant_value":"The default role that will used by kube2iam in eks clusters."},"name":{"constant_value":"test-default"}},"schema_version":0},{"address":"aws_iam_role_policy_attachment.service-policy-attachment-default","mode":"managed","type":"aws_iam_role_policy_attachment","name":"service-policy-attachment-default","provider_config_key":"aws","expressions":{"policy_arn":{"references":["aws_iam_policy.service-policy-default"]},"role":{"references":["aws_iam_role.service-role-default"]}},"schema_version":0},{"address":"data.aws_caller_identity.current","mode":"data","type":"aws_caller_identity","name":"current","provider_config_key":"aws","schema_version":0}]}}}`,
			expect: nil,
		},
	}
	for name, tt := range tests {
		t.Run(name, func(t *testing.T) {
			var plan tfjson.Plan
			json.Unmarshal([]byte(tt.policy), &plan)
			v := CheckIamPolicyStar(plan)
			assert.Equal(t, tt.expect, v)
		})
	}
}

func TestCheckVpcDefinition(t *testing.T) {
	var tests = map[string]struct {
		policy string
		expect []string
	}{
		"defines vpc": {
			policy: `{"format_version":"0.1","terraform_version":"0.12.12","planned_values":{"root_module":{"resources":[{"address":"aws_vpc.test","mode":"managed","type":"aws_vpc","name":"test","provider_name":"aws","schema_version":1,"values":{"assign_generated_ipv6_cidr_block":false,"cidr_block":"10.0.0.0/16","enable_dns_support":true,"instance_tenancy":"default","tags":null}}]}},"resource_changes":[{"address":"aws_vpc.test","mode":"managed","type":"aws_vpc","name":"test","provider_name":"aws","change":{"actions":["create"],"before":null,"after":{"assign_generated_ipv6_cidr_block":false,"cidr_block":"10.0.0.0/16","enable_dns_support":true,"instance_tenancy":"default","tags":null},"after_unknown":{"arn":true,"default_network_acl_id":true,"default_route_table_id":true,"default_security_group_id":true,"dhcp_options_id":true,"enable_classiclink":true,"enable_classiclink_dns_support":true,"enable_dns_hostnames":true,"id":true,"ipv6_association_id":true,"ipv6_cidr_block":true,"main_route_table_id":true,"owner_id":true}}}],"configuration":{"provider_config":{"aws":{"name":"aws","version_constraint":"~\u003e 2.0","expressions":{"region":{"constant_value":"us-west-2"}}}},"root_module":{"resources":[{"address":"aws_vpc.test","mode":"managed","type":"aws_vpc","name":"test","provider_config_key":"aws","expressions":{"cidr_block":{"constant_value":"10.0.0.0/16"}},"schema_version":1}]}}}`,
			expect: []string{"aws_vpc.test"},
		},
		"no vpc defined": {
			policy: `{"format_version":"0.1","terraform_version":"0.12.12","planned_values":{"root_module":{"resources":[{"address":"aws_iam_policy.service-policy-default","mode":"managed","type":"aws_iam_policy","name":"service-policy-default","provider_name":"aws","schema_version":0,"values":{"description":"This policy contains default permissions that will be granted to pods in eks clusters if a kube2iam role annotation is not specified on a pod.","name":"test-default","name_prefix":null,"path":"/","policy":"{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"eks:DescribeCluster\",\n                \"eks:ListClusters\"\n            ],\n            \"Resource\": \"arn:aws:eks:*:197353405550:cluster/*\"\n        }\n    ]\n}\n"}},{"address":"aws_iam_role.service-role-default","mode":"managed","type":"aws_iam_role","name":"service-role-default","provider_name":"aws","schema_version":0,"values":{"assume_role_policy":"{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"ec2.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\n","description":"The default role that will used by kube2iam in eks clusters.","force_detach_policies":false,"max_session_duration":3600,"name":"test-default","name_prefix":null,"path":"/","permissions_boundary":null,"tags":null}},{"address":"aws_iam_role_policy_attachment.service-policy-attachment-default","mode":"managed","type":"aws_iam_role_policy_attachment","name":"service-policy-attachment-default","provider_name":"aws","schema_version":0,"values":{"role":"test-default"}}]}},"resource_changes":[{"address":"aws_iam_policy.service-policy-default","mode":"managed","type":"aws_iam_policy","name":"service-policy-default","provider_name":"aws","change":{"actions":["create"],"before":null,"after":{"description":"This policy contains default permissions that will be granted to pods in eks clusters if a kube2iam role annotation is not specified on a pod.","name":"test-default","name_prefix":null,"path":"/","policy":"{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Effect\": \"Allow\",\n            \"Action\": [\n                \"eks:DescribeCluster\",\n                \"eks:ListClusters\"\n            ],\n            \"Resource\": \"arn:aws:eks:*:197353405550:cluster/*\"\n        }\n    ]\n}\n"},"after_unknown":{"arn":true,"id":true}}},{"address":"aws_iam_role.service-role-default","mode":"managed","type":"aws_iam_role","name":"service-role-default","provider_name":"aws","change":{"actions":["create"],"before":null,"after":{"assume_role_policy":"{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"ec2.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\n","description":"The default role that will used by kube2iam in eks clusters.","force_detach_policies":false,"max_session_duration":3600,"name":"test-default","name_prefix":null,"path":"/","permissions_boundary":null,"tags":null},"after_unknown":{"arn":true,"create_date":true,"id":true,"unique_id":true}}},{"address":"aws_iam_role_policy_attachment.service-policy-attachment-default","mode":"managed","type":"aws_iam_role_policy_attachment","name":"service-policy-attachment-default","provider_name":"aws","change":{"actions":["create"],"before":null,"after":{"role":"test-default"},"after_unknown":{"id":true,"policy_arn":true}}}],"prior_state":{"format_version":"0.1","terraform_version":"0.12.12","values":{"root_module":{"resources":[{"address":"data.aws_caller_identity.current","mode":"data","type":"aws_caller_identity","name":"current","provider_name":"aws","schema_version":0,"values":{"account_id":"197353405550","arn":"arn:aws:iam::197353405550:user/jeff.wenzbauer","id":"2019-10-23 22:47:25.509677 +0000 UTC","user_id":"AIDAIJRVWOOD62AKW2AJ4"}}]}}},"configuration":{"provider_config":{"aws":{"name":"aws","version_constraint":"~\u003e 2.0","expressions":{"region":{"constant_value":"us-west-2"}}}},"root_module":{"resources":[{"address":"aws_iam_policy.service-policy-default","mode":"managed","type":"aws_iam_policy","name":"service-policy-default","provider_config_key":"aws","expressions":{"description":{"constant_value":"This policy contains default permissions that will be granted to pods in eks clusters if a kube2iam role annotation is not specified on a pod."},"name":{"constant_value":"test-default"},"policy":{"references":["data.aws_caller_identity.current"]}},"schema_version":0},{"address":"aws_iam_role.service-role-default","mode":"managed","type":"aws_iam_role","name":"service-role-default","provider_config_key":"aws","expressions":{"assume_role_policy":{"constant_value":"{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"ec2.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\n"},"description":{"constant_value":"The default role that will used by kube2iam in eks clusters."},"name":{"constant_value":"test-default"}},"schema_version":0},{"address":"aws_iam_role_policy_attachment.service-policy-attachment-default","mode":"managed","type":"aws_iam_role_policy_attachment","name":"service-policy-attachment-default","provider_config_key":"aws","expressions":{"policy_arn":{"references":["aws_iam_policy.service-policy-default"]},"role":{"references":["aws_iam_role.service-role-default"]}},"schema_version":0},{"address":"data.aws_caller_identity.current","mode":"data","type":"aws_caller_identity","name":"current","provider_config_key":"aws","schema_version":0}]}}}`,
			expect: nil,
		},
	}
	for name, tt := range tests {
		t.Run(name, func(t *testing.T) {
			var plan tfjson.Plan
			json.Unmarshal([]byte(tt.policy), &plan)
			v := CheckVpcDefinition(plan)
			assert.Equal(t, tt.expect, v)
		})
	}
}
